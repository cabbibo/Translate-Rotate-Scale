<html>
  <head>
    <style>

      #container{

        background:#000;
        position:absolute;
        top:0px;
        left:0px;

      }

    </style>
  </head>
  <body>    

    <div id="container"></div>

    <script src="lib/leap.js"></script>
    <script src="lib/three.js"></script>
    <script src="lib/OBJLoader.js"></script>
    <script src="lib/TrackballControls.js"></script>
    <script src="lib/RiggedSkeleton.js"></script>
    <script src="lib/ObjectControls.js"></script>

    <script src="lib/jquery.min.js"></script>
    <script src="lib/ShaderLoader.js"></script>

    <script src="lib/AudioController.js"></script>
    <script src="lib/AudioTexture.js"></script>
    <script src="lib/Stream.js"></script>
    <script src="lib/UserAudio.js"></script>
    <script src="lib/underscore.js"></script>

    <script src="lib/ParticleUtils.js"></script>
    <script src="lib/PhysicsRenderer.js"></script>


    <script src="lib/Cloth.js"></script>
    
    <script>

console.log( THREE );
      var container , camera , scene, renderer , stats;

      var controller , controls;

      var numOfObjects = 10;
      var objectControls;
      var clock;
      console.log( THREE.OBJLoader );
      var OBJLoader = new THREE.OBJLoader();

      var helixGeo ;

      var riggedSkeleton , riggedSkeleton1;

      var shaders = new ShaderLoader('shaders');

      shaders.shaderSetLoaded = function(){
        init();
        animate();
        //stream.play();*/
      }

      shaders.load( 'vs-iri' , 'iri' , 'vertex' );
      shaders.load( 'fs-iri' , 'iri' , 'fragment' );
      shaders.load( 'vs-jelly' , 'jelly' , 'vertex' );
      shaders.load( 'fs-jelly' , 'jelly' , 'fragment' );
      shaders.load( 'vs-column' , 'column' , 'vertex' );
      shaders.load( 'fs-column' , 'column' , 'fragment' );
      shaders.load( 'sim-column' , 'column' , 'simulation' );

      shaders.load( 'jellySim'  , 'jellySim' , 'simulation'  );


      
      var audioController = new AudioController();
      
     var dT = { type:"f" , value:0 }

      var timer = { type:"f" , value:0 };
 
      
      audioController.mute.gain.value = 0.0;

      //var userAudio = new UserAudio( audioController );
      
      //userAudio.onStreamCreated = function(){
     // }

      function init(){

        controller = new Leap.Controller();
     
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(
          50 ,
          window.innerWidth / window.innerHeight,
          1 ,
          1000
        );

        camera.position.z = 200;
   
        console.log( camera );
        clock = new THREE.Clock();
        controls = new THREE.TrackballControls( camera  );

        var geometry = new THREE.BoxGeometry( 1 , 1 , 1 );
        var material = new THREE.MeshNormalMaterial();

        container = document.getElementById( 'container' );
        renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        container.appendChild( renderer.domElement );    

        for( var i = 0; i < 6; i++ ){

          var color = new THREE.Color();
          color.r = Math.random();
          color.g = Math.random();
          color.b = Math.random();

          var light = new THREE.DirectionalLight( color , 1 );
          light.position.x = ( i < 2 ?  i - .5 : 0);
          light.position.y = ( i < 4 && i > 2 ? ( i - 2 ) - .5 : 0 );
          light.position.z = ( i < 6 && i > 4 ? ( i - 4 ) - .5 : 0 );
          scene.add( light );

        }
        

        riggedSkeleton = initHand();
        riggedSkeleton1 = initHand();
        
        var mesh = new THREE.Mesh(
          new THREE.IcosahedronGeometry( 3 , 0 ),
          new THREE.MeshLambertMaterial()
        );

        objectControls = new ObjectControls( 
          camera , 
          riggedSkeleton.hand , 
          riggedSkeleton1.hand , 
          controller , 
          {
            indicator : mesh     
          }
        );
       
        //objectControls.addIndicator();
        //scene.add( mesh );


              var white = new THREE.Color( 1 , 1 , 1 );

              var hoverOver = function(){

                console.log( 'hoverOver' );
                this.material.opacity = 1;
                this.material.color = white;
                this.material.transparent = true;

              }

              var hoverOut = function(){

                console.log( 'hoverOut' );
                console.log( this.uuid );
                this.material.opacity = .3;
                this.material.transparent = true;

              }

              var select = function(){

                this.material.wireframe = true;

              }

              var deselect = function(){

                this.material.wireframe = false;

              }

              for( var i = 0; i < 1 ; i ++ ){

                var color     = new THREE.Color( i / numOfObjects , 0 , 1 );
                var specular  = new THREE.Color( 1 , 0 , i / numOfObjects );
                var newMat    = new THREE.MeshLambertMaterial({
                  color:color,
                  specular: specular  
                });

                var geo = new THREE.IcosahedronGeometry( 4 , 1 );
                //var geo = child.geometry;
                var mesh = new THREE.Mesh( geo , newMat );
                scene.add( mesh );

                mesh.scale.multiplyScalar( 2 );
                mesh.rotation.x = Math.PI / 2;

                var size = Math.ceil( Math.sqrt( numOfObjects ) );
                var x = Math.floor( i / size );
                var y = (i - (x * size ) ) / size;
                mesh.position.y = ( y - .5 ) * 100;
                mesh.position.x = ( x/size - .5 ) * 100;

                mesh.hoverOut = hoverOut;
                mesh.hoverOver = hoverOver;
                mesh.select = select;
                mesh.deselect = deselect;

                objectControls.add( mesh );

                
                cloth = new Cloth( mesh.position );
                cloth.physicsRenderer.addDebugScene( scene );
                cloth.physicsRenderer.debugScene.scale.multiplyScalar( .3 );
                cloth.physicsRenderer.debugScene.position.y = 30;

              }

              animate();




        controller.connect();

        window.addEventListener( 'resize', onResize , false );
        

      }


      function initHand(){


        var riggedSkeleton = new RiggedSkeleton( controller , {

            handSize: 10,
            movementSize: 100,

        });



        var obj = new THREE.Mesh(
            new THREE.BoxGeometry( 10 , 10 , 100 ),//helixGeo,
            new THREE.MeshNormalMaterial()
        );

        obj.scale.multiplyScalar( .001 );
        

        riggedSkeleton.addScaledFingerMesh( obj , 'thumb' );
        riggedSkeleton.addScaledFingerMesh( obj , 'index' );
        riggedSkeleton.addScaledFingerMesh( obj , 'middle'  );
        riggedSkeleton.addScaledFingerMesh( obj , 'ring' );
        riggedSkeleton.addScaledFingerMesh( obj , 'pinky'  );

        riggedSkeleton.addToScene( scene );

        console.log( riggedSkeleton );

        return riggedSkeleton;

      }
      
      function onResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate(){

        
        dT.value = clock.getDelta();

        timer.value += dT.value;

        audioController.update();

        //if( !physicsPaused ){
        cloth.update();
        //}

        //console.log( riggedSkeleton.hand.position );
        riggedSkeleton.update( 0 );
        riggedSkeleton1.update( 1 );
        objectControls.update();
        controls.update();
        renderer.render( scene , camera );

        requestAnimationFrame( animate );

      }


    </script>

  </body>
</html>
